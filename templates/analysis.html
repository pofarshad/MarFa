<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - MarFaNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-mobile-alt me-2"></i>
                MarFaNet Refactoring Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link active" href="/analysis">Analysis</a>
                <a class="nav-link" href="/specifications">Specifications</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Analysis Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-microscope me-2"></i>
                            Hiddify App Analysis Results
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 class="text-primary">Dependencies</h5>
                                    <h2 id="dep-count">-</h2>
                                    <small class="text-muted">Total dependencies</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 class="text-warning">Sing-box References</h5>
                                    <h2 id="singbox-count">-</h2>
                                    <small class="text-muted">Files to modify</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 class="text-success">Kotlin Files</h5>
                                    <h2 id="kotlin-count">-</h2>
                                    <small class="text-muted">Source files</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 class="text-info">Resources</h5>
                                    <h2 id="resource-count">-</h2>
                                    <small class="text-muted">Resource files</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dependency Analysis -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cubes me-2"></i>Current Dependencies</h5>
                    </div>
                    <div class="card-body">
                        <div id="current-dependencies">
                            <p class="text-muted">Loading dependency analysis...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-exchange-alt me-2"></i>Required Changes</h5>
                    </div>
                    <div class="card-body">
                        <div id="required-changes">
                            <p class="text-muted">Loading change analysis...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Structure Analysis -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-sitemap me-2"></i>Code Structure Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Module</th>
                                        <th>Files</th>
                                        <th>Sing-box Dependencies</th>
                                        <th>Priority</th>
                                        <th>Actions Required</th>
                                    </tr>
                                </thead>
                                <tbody id="structure-analysis">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            Loading structure analysis...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Xray Integration Plan -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-road me-2"></i>Xray Integration Plan</h5>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="integrationAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1">
                                        Step 1: Remove Sing-box Dependencies
                                    </button>
                                </h2>
                                <div id="step1" class="accordion-collapse collapse show" data-bs-parent="#integrationAccordion">
                                    <div class="accordion-body">
                                        <ul id="step1-tasks">
                                            <li>Loading step 1 tasks...</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2">
                                        Step 2: Add Xray Core Integration
                                    </button>
                                </h2>
                                <div id="step2" class="accordion-collapse collapse" data-bs-parent="#integrationAccordion">
                                    <div class="accordion-body">
                                        <ul id="step2-tasks">
                                            <li>Loading step 2 tasks...</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step3">
                                        Step 3: Update Code Paths
                                    </button>
                                </h2>
                                <div id="step3" class="accordion-collapse collapse" data-bs-parent="#integrationAccordion">
                                    <div class="accordion-body">
                                        <ul id="step3-tasks">
                                            <li>Loading step 3 tasks...</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row">
            <div class="col-12 text-center">
                <button class="btn btn-primary me-3" onclick="refreshAnalysis()">
                    <i class="fas fa-refresh me-2"></i>Refresh Analysis
                </button>
                <button class="btn btn-success me-3" onclick="exportAnalysis()">
                    <i class="fas fa-download me-2"></i>Export Analysis
                </button>
                <a href="/specifications" class="btn btn-info">
                    <i class="fas fa-arrow-right me-2"></i>Generate Specifications
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        // Load analysis data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalysisData();
        });

        function loadAnalysisData() {
            // Simulate loading analysis data
            setTimeout(() => {
                updateAnalysisDisplay({
                    dependencies: 45,
                    singbox_references: 23,
                    kotlin_files: 156,
                    resource_files: 89
                });
            }, 1000);
        }

        function updateAnalysisDisplay(data) {
            document.getElementById('dep-count').textContent = data.dependencies;
            document.getElementById('singbox-count').textContent = data.singbox_references;
            document.getElementById('kotlin-count').textContent = data.kotlin_files;
            document.getElementById('resource-count').textContent = data.resource_files;

            // Update detailed analysis sections
            updateDependenciesSection();
            updateChangesSection();
            updateStructureTable();
            updateIntegrationSteps();
        }

        function updateDependenciesSection() {
            const deps = [
                'io.github.sagernet:sing-box-core:1.8.0',
                'io.github.sagernet:sing-box-jni:1.8.0',
                'io.github.sagernet:libbox-jni:1.8.0'
            ];
            
            const html = deps.map(dep => 
                `<div class="badge bg-warning text-dark me-2 mb-2">${dep}</div>`
            ).join('');
            
            document.getElementById('current-dependencies').innerHTML = html;
        }

        function updateChangesSection() {
            const changes = [
                'Replace Sing-box JNI with Xray core',
                'Update Gradle dependencies',
                'Modify native library loading',
                'Update configuration models'
            ];
            
            const html = changes.map(change => 
                `<div class="alert alert-info py-2 mb-2">${change}</div>`
            ).join('');
            
            document.getElementById('required-changes').innerHTML = html;
        }

        function updateStructureTable() {
            const modules = [
                {
                    name: 'Core',
                    files: 45,
                    dependencies: 8,
                    priority: 'High',
                    actions: 'Replace JNI bindings'
                },
                {
                    name: 'UI',
                    files: 67,
                    dependencies: 3,
                    priority: 'Medium',
                    actions: 'Update configuration UI'
                },
                {
                    name: 'Service',
                    files: 23,
                    dependencies: 12,
                    priority: 'High',
                    actions: 'Modify VPN service'
                }
            ];
            
            const html = modules.map(module => `
                <tr>
                    <td>${module.name}</td>
                    <td>${module.files}</td>
                    <td>${module.dependencies}</td>
                    <td><span class="badge bg-${module.priority === 'High' ? 'danger' : 'warning'}">${module.priority}</span></td>
                    <td>${module.actions}</td>
                </tr>
            `).join('');
            
            document.getElementById('structure-analysis').innerHTML = html;
        }

        function updateIntegrationSteps() {
            const step1Tasks = [
                'Remove sing-box-core dependency from build.gradle',
                'Delete JNI wrapper classes',
                'Remove native library loading code',
                'Clean up build configurations'
            ];
            
            const step2Tasks = [
                'Add Xray core dependency',
                'Create new JNI interface',
                'Implement Xray configuration bridge',
                'Add native library placeholders'
            ];
            
            const step3Tasks = [
                'Update VPN service implementation',
                'Modify configuration parsers',
                'Update protocol handlers',
                'Test integration points'
            ];
            
            document.getElementById('step1-tasks').innerHTML = 
                step1Tasks.map(task => `<li>${task}</li>`).join('');
            document.getElementById('step2-tasks').innerHTML = 
                step2Tasks.map(task => `<li>${task}</li>`).join('');
            document.getElementById('step3-tasks').innerHTML = 
                step3Tasks.map(task => `<li>${task}</li>`).join('');
        }

        function refreshAnalysis() {
            loadAnalysisData();
        }

        function exportAnalysis() {
            // Export analysis data
            const data = {
                timestamp: new Date().toISOString(),
                analysis: {
                    dependencies: document.getElementById('dep-count').textContent,
                    singbox_references: document.getElementById('singbox-count').textContent,
                    kotlin_files: document.getElementById('kotlin-count').textContent,
                    resource_files: document.getElementById('resource-count').textContent
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hiddify-analysis-report.json';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
