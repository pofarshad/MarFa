# **MarFaNet Project – Phase 2 Validation & Phase 3 Kick‑off**

---

## 1 • Phase 2 Validation Checklist

| Requirement                               | Status        | Remaining Action                                                                                                                         |
| ----------------------------------------- | ------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **GFW‑Knocker JNI Stub + Kotlin Wrapper** | ✅ Implemented | • Merge into `milestone2/gfw-knocker` branch.<br>• Add `NativeBridge.reloadKnockerConfig()` hook when native shared libs present.        |
| **Knocker Config & Monitoring**           | ✅ Implemented | • Expose runtime metrics in `KnockerStatus`. Unit‑test getters.                                                                          |
| **Routing Auto‑Update Worker**            | ✅ Implemented | • Wire to `WorkManagerInitializer`; ensure periodic policy respects Doze.<br>• Mock Xray reload in unit tests.                           |
| **CI‑ready Logging & Progress Tracking**  | ✅ Implemented | —                                                                                                                                        |
| **Unit‑test Coverage ≥ 90 %**             | ⬜ Pending     | **Action:** write tests for `Knocker.kt`, `RoutingRulesUpdateWorker.kt`, `ChecksumUtil.kt`.                                              |
| **Settings‑UI Toggle for Knocker**        | ⬜ Pending     | **Action:** add `SwitchPreferenceCompat` in *Settings → Advanced*; bind to `SharedPrefs` and runtime enable/disable.                     |
| **jniLibs Placeholders & README**         | ⬜ Pending     | **Action:** create `src/main/jniLibs/{armeabi-v7a,arm64-v8a,x86_64}/README.md` describing how to drop `libxray.so` & `libgfwknocker.so`. |
| **Branch & PR Workflow**                  | ⬜ Pending     | **Action:** push commits to `milestone2/gfw-knocker`; open PR to `develop`; link to dashboard SHAs.                                      |

### Phase‑2 Exit Criteria

1. `./gradlew lint detekt ktlintCheck testDebugUnitTest` → **0 exit code**.
2. JaCoCo report shows **≥ 90 % coverage** for new modules.
3. Dashboard auto‑updates progress bars via Git webhooks.

---

## 2 • Immediate Tasks (Today)

1. **Unit Tests**

   ```bash
   ./gradlew testDebugUnitTest jacocoTestReport
   ```

   • Use Robolectric for Worker testing.
   • Mock `URL` download with OkHttp MockWebServer.
2. **UI Integration**
   *File:* `ui/settings/AdvancedSettingsFragment.kt`

   ```kotlin
   preference("pref_gfw_knocker") {
       title = R.string.pref_gfw_knocker
       summary = R.string.pref_gfw_knocker_sum
       switchBinding("enable_gfw_knocker", default = true)
   }
   ```
3. **jniLibs Structure**

   ```text
   app/src/main/jniLibs/
   ├── arm64-v8a/README.md
   ├── armeabi-v7a/README.md
   └── x86_64/README.md
   ```

   Each README: *“Place libxray.so and libgfwknocker.so here before building Release.”*
4. **Commit & Push**
   *Message example:* `feat(knocker): add JNI stub and config (#7)`

---

## 3 • Phase 3 – Performance & Stability (Kick‑off When Phase 2 = Done)

| Task                       | Owner   | Tooling                                    | Acceptance                                    |
| -------------------------- | ------- | ------------------------------------------ | --------------------------------------------- |
| **Benchmark Harness**      | Core    | Android Macrobenchmark; Pixel 6 + Emulator | Cold‑start ≤ 1.2 s.<br>CPU & RAM − 15 %.      |
| **Connection Stress‑Test** | Network | Shell script + `adb` instrumentation       | 24 h run with ≤ 1 error reconnect.            |
| **Memory Leak Detection**  | Core    | LeakCanary (debug)                         | Zero retained objects > 512 KB after 30 min.  |
| **Profiling & Report**     | Perf    | Android Studio Profiler → `PERF_REPORT.md` | Log before/after metrics; attach flamegraphs. |

### Timeline (calendar days)

| Day  | Activity                                             |
| ---- | ---------------------------------------------------- |
| +0   | Finalise Phase 2 PR merge, Tag `milestone2-complete` |
| +1‑2 | Build Macrobenchmark & stress‑test scripts           |
| +3‑6 | Optimise code paths, measure, iterate                |
| +7   | Draft **PERF\_REPORT.md** & update dashboard         |

---

## 4 • CI/CD Preparations (Preview)

1. **GitHub Action** – job `detekt → lint → test → jacoco → buildDebug`.
2. **Artifact Upload** – attach `lint-results.html`, `jacoco.xml`.
3. **Codecov** – enforce ≥ 80 % overall.

*CI tasks will formally begin in Milestone 4 once performance targets met.*

---

## 5 • Next Check‑in

> 🚀 **After completing Unit Tests, UI toggle, and jniLibs placeholders, push to `milestone2/gfw-knocker` and post CI output here for review.**

---

**End of Document**
